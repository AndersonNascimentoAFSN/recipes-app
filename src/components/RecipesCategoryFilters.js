import React, { useEffect, useState } from 'react';
import PropTypes from 'prop-types';
import { getCategories } from '../services/api';
import useRecipesContext from '../hooks/useRecipesContext';
import './recipesCategoryFilters.css';
import setStateButtonsFilters from '../utils/toggleButtonsFilters';

export default function RecipesCategoryFilters({ typeRecipes }) {
  const [recipesCategories, setRecipesCategories] = useState([]);
  const {
    setFilters, stateButtonsFilter,
    setStateButtonsFilter,
  } = useRecipesContext();

  useEffect(() => {
    getCategories(typeRecipes).then((data) => {
      const quantityCategories = 5;
      const categoriesList = data[typeRecipes]
        .filter((_, index) => index < quantityCategories);
      setRecipesCategories(categoriesList);
    });
  }, [typeRecipes]);

  function checkStateButtons() {
    const stateButtons = Object.values(stateButtonsFilter);
    return stateButtons.every((buttonState) => buttonState === false);
  }

  useEffect(() => {
    const buttonState = checkStateButtons();
    if (buttonState) {
      setFilters({ search: '', parameter: 'name' });
    }
  }, [stateButtonsFilter]);

  function handleClickButtonAll() {
    setFilters({ search: '', parameter: 'name' });
  }

  function setFiltersStates(target, filter) {
    setFilters(filter);
    setStateButtonsFilters(target, setStateButtonsFilter, recipesCategories);
  }

  function handleClick({ target }) {
    const { textContent } = target;
    const filter = {
      search: textContent,
      parameter: 'category',
    };
    switch (typeRecipes) {
    case 'meals':
      setFiltersStates(target, filter);
      break;
    case 'drinks':
      setFiltersStates(target, filter);
      break;
    default:
      return '';
    }
  }
  return (
    <div className="recipesCategoryFilters__containers">
      {recipesCategories.map(({ strCategory }, index) => (
        <button
          key={ index }
          type="button"
          data-testid={ `${strCategory}-category-filter` }
          onClick={ handleClick }
          className="recipesCategoryFilters__button"
        >
          {strCategory}
        </button>
      ))}
      <button
        type="button"
        onClick={ handleClickButtonAll }
        data-testid="All-category-filter"
      >
        All
      </button>
    </div>
  );
}

RecipesCategoryFilters.propTypes = {
  typeRecipes: PropTypes.string.isRequired,
};
